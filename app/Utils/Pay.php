<?php
namespace App\Utils;use App\Models\User;use App\Models\Code;use App\Models\Paylist;use App\Models\Payback;use App\Services\Config;class Pay{public static function getHTML($a){$b=Config::get("payment_system");switch($b){case  "paymentwall":return Pay::pmw_html($a);case  'spay':return Pay::spay_html($a);case  'zfbjk':return Pay::zfbjk_html($a);case  'f2fpay':return Pay::f2fpay_html($a);default:return"";}return null;}private static function spay_html($a){return '
						<form action="/user/alipay" method="get" target="_blank" >
							<h3>支付宝充值</h3>
							<p>充值金额: <input type="text" name="amount" /></p>
							<input type="submit" value="提交" />
						</form>
';}private static function zfbjk_html($a){return '
						<p>请扫码，给我转账来充值，记得备注上 <code>'.$a->id.'</code>。<br></p>
						<img src="'.Config::get('zfbjk_qrcodeurl').'"/>
';}private static function f2fpay_html($a){$c=substr(md5($_SERVER['SERVER_NAME']),6,5);$d=Config::get("f2fpay_activate_key");if($d!=$c){return '
						<p class="card-heading">使用支付宝充值</p>
						<label for="number">您好像没有激活，请联系<a href="https://web.telegram.org/#/im?p=u369173679_3082441468848409198">秋名山飞车党</a>寻找激活码哦，点击查看<a href="https://91vps.club/2017/06/09/alipay_f2f_ss_panel_mod/">使用教程</a>。</label>
						<p></p>						
';}else{return '
						<p class="card-heading">使用支付宝充值</p>
						<label for="number">请选择充值金额：</label>
						<select id="type" class="form-control" name="amount">
							<option value="10">10元</option>
							<option value="20">20元</option>
							<option value="50">50元</option>
							<option value="100">100元</option>
							<option value="200">200元</option>
						</select>
						<p></p>
						<a class="btn btn-flat waves-attach" id="urlChange" ><span class="icon">check</span>&nbsp;充值</a>
';}}private static function pmw_html($a){\Paymentwall_Config::getInstance()->set(array('api_type'=>\Paymentwall_Config::API_VC,'public_key'=>Config::get('pmw_publickey'),'private_key'=>Config::get('pmw_privatekey')));$e=new\Paymentwall_Widget($a->id,Config::get('pmw_widget'),array(),array('email'=>$a->email,'history'=>array('registration_date'=>strtotime($a->reg_date),'registration_ip'=>$a->reg_ip,'payments_number'=>Code::where('userid','=',$a->id)->where('type','=',-1)->count(),'membership'=>$a->class),'customer'=>array('username'=>$a->user_name)));return $e->getHtmlCode(array("height"=>Config::get('pmw_height'),"width"=>"100%"));}private static function spay_gen($a,$f){$g=Spay_tool::getConfig();$h=new Paylist();$h->userid=$a->id;$h->total=$f;$h->save();$i=$h->id;$j=$h->id."UID".$a->id." 充值".$f."元";$k=(double) $f;$l=$a->id;$m=array("service"=>"create_direct_pay_by_user","partner"=>trim($g['partner']),"notify_url"=>$g['notify_url'],"return_url"=>$g['return_url'],"out_trade_no"=>$i,"total_fee"=>$k);$n=new Spay_submit($g);$o=$n->buildRequestForm($m,"get","确认");echo $o;exit(0);}private static function get_alipay_config(){$p=array('sign_type'=>"RSA2",'alipay_public_key'=>Config::get("alipay_public_key"),'merchant_private_key'=>Config::get("merchant_private_key"),'charset'=>"UTF-8",'gatewayUrl'=>"https://openapi.alipay.com/gateway.do",'app_id'=>Config::get("f2fpay_app_id"),'notify_url'=>Config::get("baseUrl")."/pay_callback",'MaxQueryRetry'=>"10",'QueryDuration'=>"3");return $p;}public static function alipay_get_qrcode($a,$f,&$q){$h=new Paylist();$h->userid=$a->id;$h->total=$f;$h->save();$p=Pay::get_alipay_config();$r=$h->id;$j="在".Config::get("appName")."充值".$h->total."元";$s=$h->total;$t="0.01";$l="用户名:".$a->user_name." 用户ID:".$a->id." 用户充值共计".$h->total."元";$u="bak_admin0001";$v="bak_store001";$w="";$x=new\ExtendParams();$x->setSysServiceProviderId($w);$y=$x->getExtendParams();$z="5m";$aa=array();$bb=new\GoodsDetail();$bb->setGoodsId($h->total);$bb->setGoodsName("充值");$bb->setPrice($h->total);$bb->setQuantity(1);$cc=$bb->getGoodsDetail();$aa=array($cc);$dd="";$ee=new\AlipayTradePrecreateContentBuilder();$ee->setOutTradeNo($r);$ee->setTotalAmount($s);$ee->setTimeExpress($z);$ee->setSubject($j);$ee->setBody($l);$ee->setUndiscountableAmount($t);$ee->setExtendParams($y);$ee->setGoodsDetailList($aa);$ee->setStoreId($v);$ee->setOperatorId($u);$ee->setAppAuthToken($dd);$q=new\AlipayTradeService($p);$ff=$q->qrPay($ee);return $ff;}private static function f2fpay_gen($a,$f){$ff=Pay::alipay_get_qrcode($a,$f,$q);switch($ff->getTradeStatus()){case  "SUCCESS":echo "支付金额: RMB ".$f." 元";echo "确认无误后请用支付宝App扫描二维码支付："."<br>---------------------------------------<br>";$gg=$ff->getResponse();$hh=$q->create_erweima_baidu($gg->qr_code);echo $hh."<br>";break;case  "FAILED":echo "支付宝创建订单二维码失败!!!"."<br>--------------------------<br>";if(!empty($ff->getResponse())){print_r($ff->getResponse());}echo "请使用其他方式付款。";break;case  "UNKNOWN":echo "系统异常，状态未知!!!"."<br>--------------------------<br>";if(!empty($ff->getResponse())){print_r($ff->getResponse());}echo "请使用其他方式付款。";break;default:echo "创建订单二维码返回异常!!!"."<br>--------------------------<br>";echo "请使用其他方式付款。";break;}if($ff->getTradeStatus()){sleep(1);echo "轮询处理：";}return;}public static function getGen($a,$f){$b=Config::get("payment_system");switch($b){case  "paymentwall":return Pay::pmw_html();case  'spay':return Pay::spay_gen($a,$f);case  'zfbjk':return Pay::alipay_html();case  'f2fpay':return Pay::f2fpay_gen($a,$f);default:return"";}return null;}private static function spay_callback(){if(Config::get('enable_alipay')!='false'){$ii=new Spay_notify(Spay_tool::getConfig());$jj=$ii->verifyNotify();if($jj){$i=$_POST['out_trade_no'];$kk=$_POST['trade_no'];$ll=$_POST['trade_status'];$mm=Paylist::where("id",'=',$i)->where('status',0)->where('total',$_POST['total_fee'])->first();if($mm==null){exit("success");}$mm->tradeno=$kk;$mm->status=1;$mm->save();$ll=$_POST['trade_status'];if($_POST['trade_status']=='TRADE_FINISHED'){$a=User::find($mm->userid);$a->money=$a->money+$_POST['total_fee'];$a->save();$nn=new Code();$nn->code="支付宝 充值";$nn->isused=1;$nn->type=-1;$nn->number=$_POST['total_fee'];$nn->usedatetime=date("Y-m-d H:i:s");$nn->userid=$a->id;$nn->save();if($a->ref_by!=""&&$a->ref_by!=0&&$a->ref_by!=null){$oo=User::where("id","=",$a->ref_by)->first();$oo->money=$oo->money+$nn->number*(Config::get('code_payback')/100);$oo->save();$pp=new Payback();$pp->total=$_POST['total_fee'];$pp->userid=$a->id;$pp->ref_by=$a->ref_by;$pp->ref_get=$nn->number*(Config::get('code_payback')/100);$pp->datetime=time();$pp->save();}}elseif($_POST['trade_status']=='TRADE_SUCCESS'){$a=User::find($mm->userid);$a->money=$a->money+$_POST['total_fee'];$a->save();$nn=new Code();$nn->code="支付宝 充值";$nn->isused=1;$nn->type=-1;$nn->number=$_POST['total_fee'];$nn->usedatetime=date("Y-m-d H:i:s");$nn->userid=$a->id;$nn->save();if($a->ref_by!=""&&$a->ref_by!=0&&$a->ref_by!=null){$oo=User::where("id","=",$a->ref_by)->first();$oo->money=$oo->money+$nn->number*(Config::get('code_payback')/100);$oo->save();$pp=new Payback();$pp->total=$_POST['total_fee'];$pp->userid=$a->id;$pp->ref_by=$a->ref_by;$pp->ref_get=$nn->number*(Config::get('code_payback')/100);$pp->datetime=time();$pp->save();}}echo "success";if(Config::get('enable_donate')=='true'){if($a->is_hide==1){Telegram::Send("姐姐姐姐，一位不愿透露姓名的大老爷给我们捐了 ".$nn->number." 元呢~");}else{Telegram::Send("姐姐姐姐，".$a->user_name." 大老爷给我们捐了 ".$nn->number." 元呢~");}}}else{echo "fail";}}}private static function pmw_callback(){if(Config::get('pmw_publickey')!=""){\Paymentwall_Config::getInstance()->set(array('api_type'=>\Paymentwall_Config::API_VC,'public_key'=>Config::get('pmw_publickey'),'private_key'=>Config::get('pmw_privatekey')));$qq=new\Paymentwall_Pingback($_GET,$_SERVER['REMOTE_ADDR']);if($qq->validate()){$rr=$qq->getVirtualCurrencyAmount();if($qq->isDeliverable()){}elseif($qq->isCancelable()){}$a=User::find($qq->getUserId());$a->money=$a->money+$qq->getVirtualCurrencyAmount();$a->save();$nn=new Code();$nn->code="Payment Wall 充值";$nn->isused=1;$nn->type=-1;$nn->number=$qq->getVirtualCurrencyAmount();$nn->usedatetime=date("Y-m-d H:i:s");$nn->userid=$a->id;$nn->save();if($a->ref_by!=""&&$a->ref_by!=0&&$a->ref_by!=null){$oo=User::where("id","=",$a->ref_by)->first();$oo->money=$oo->money+$nn->number*(Config::get('code_payback')/100);$oo->save();$pp=new Payback();$pp->total=$qq->getVirtualCurrencyAmount();$pp->userid=$a->id;$pp->ref_by=$a->ref_by;$pp->ref_get=$nn->number*(Config::get('code_payback')/100);$pp->datetime=time();$pp->save();}echo 'OK';if(Config::get('enable_donate')=='true'){if($a->is_hide==1){Telegram::Send("姐姐姐姐，一位不愿透露姓名的大老爷给我们捐了 ".$nn->number." 元呢~");}else{Telegram::Send("姐姐姐姐，".$a->user_name." 大老爷给我们捐了 ".$nn->number." 元呢~");}}}else{echo $qq->getErrorSummary();}}else{echo 'error';}}private static function zfbjk_callback($ss){$tt=Config::get("zfbjk_pid");$uu=Config::get("zfbjk_key");$vv=$ss->getParam('tradeNo');$ww=$ss->getParam('Money');$xx=$ss->getParam('title');$yy=$ss->getParam('memo');$zz=$ss->getParam('alipay_account');$aaa=$ss->getParam('Gateway');$bbb=$ss->getParam('Sign');if(!is_numeric($xx)){exit("fail");}if(strtoupper(md5($tt.$uu.$vv.$ww.$xx.$yy))==strtoupper($bbb)){$mm=Paylist::where("tradeno",'=',$vv)->first();if($mm!=null){exit("success");}else{$a=User::where('id','=',$xx)->first();if($a==null){exit("IncorrectOrder");}$h=new Paylist();$h->userid=$xx;$h->tradeno=$vv;$h->total=$ww;$h->datetime=time();$h->status=1;$h->save();$a->money=$a->money+$ww;$a->save();$nn=new Code();$nn->code="支付宝充值";$nn->isused=1;$nn->type=-1;$nn->number=$ww;$nn->usedatetime=date("Y-m-d H:i:s");$nn->userid=$a->id;$nn->save();if($a->ref_by!=""&&$a->ref_by!=0&&$a->ref_by!=null){$oo=User::where("id","=",$a->ref_by)->first();$oo->money=$oo->money+$nn->number*(Config::get('code_payback')/100);$oo->save();$pp=new Payback();$pp->total=$ww;$pp->userid=$a->id;$pp->ref_by=$a->ref_by;$pp->ref_get=$nn->number*(Config::get('code_payback')/100);$pp->datetime=time();$pp->save();}if(Config::get('enable_donate')=='true'){if($a->is_hide==1){Telegram::Send("姐姐姐姐，一位不愿透露姓名的大老爷给我们捐了 ".$nn->number." 元呢~");}else{Telegram::Send("姐姐姐姐，".$a->user_name." 大老爷给我们捐了 ".$nn->number." 元呢~");}}exit("Success");}}else{exit('Fail');}}private static function f2fpay_callback(){$ccc=new\AopClient();$ddd=Config::get("alipay_public_key");$ccc->alipayrsaPublicKey=$ddd;$eee=$_POST;$fff=$ccc->rsaCheckV1($eee,$ddd,$_POST['sign_type']);if($fff){$i=$_POST['out_trade_no'];$kk=$_POST['trade_no'];$ll=$_POST['trade_status'];$ggg=Config::get("f2fpay_p_id");if($_POST['seller_id']!=$ggg){exit("success");}$mm=Paylist::where("id",'=',$i)->where('status',0)->where('total',$_POST['total_amount'])->first();if($mm==null){exit("success");}if($ll=='TRADE_FINISHED'||$ll=='TRADE_SUCCESS'){$mm->tradeno=$kk;$mm->status=1;$mm->save();$a=User::find($mm->userid);$a->money=$a->money+$_POST['total_amount'];if($a->class==0){$a->class_expire=date("Y-m-d H:i:s",time());$a->class_expire=date("Y-m-d H:i:s",strtotime($a->class_expire)+86400);$a->class=1;}$a->save();$nn=new Code();$nn->code="支付宝 充值";$nn->isused=1;$nn->type=-1;$nn->number=$_POST['total_amount'];$nn->usedatetime=date("Y-m-d H:i:s");$nn->userid=$a->id;$nn->save();if($a->ref_by!=""&&$a->ref_by!=0&&$a->ref_by!=null){$oo=User::where("id","=",$a->ref_by)->first();$oo->money=$oo->money+$nn->number*(Config::get('code_payback')/100);$oo->save();$pp=new Payback();$pp->total=$_POST['total_amount'];$pp->userid=$a->id;$pp->ref_by=$a->ref_by;$pp->ref_get=$nn->number*(Config::get('code_payback')/100);$pp->datetime=time();$pp->save();}if(Config::get('enable_donate')=='true'){if($a->is_hide==1){Telegram::Send("一位不愿透露姓名的大老爷给我们捐了 ".$nn->number." 元!");}else{Telegram::Send($a->user_name." 大老爷给我们捐了 ".$nn->number." 元！");}}echo "success";}}else{echo "fail";}}public static function callback($ss){$b=Config::get("payment_system");switch($b){case  "paymentwall":return Pay::pmw_callback();case  'spay':return Pay::spay_callback();case  'zfbjk':return Pay::zfbjk_callback($ss);case  'f2fpay':return Pay::f2fpay_callback();default:return"";}return null;}}